-- Prompt for CMD.EXE
nyagos.env.prompt = '$P$s'

-- Prompt for NYAGOS.EXE
do
  local function branch_info()
    local path = nyagos.getwd()

    repeat
      if nyagos.access(nyagos.pathjoin(path, '.git'), 0) then
        break
      end
      path = path:match('^(.+)\\')
    until not path

    if not path then
      return nil
    end

    local status = nyagos.eval('git status -b --porcelain')
    local lines = {}

    for line in status:gmatch('[^\n]+') do
      table.insert(lines, line)
    end

    local branch = lines[1]:gsub('##%s([^\\.]+).*', '%1')
    local staged, unstaged, conflicted = 0, 0, 0

    for i = 2, #lines do
      if lines[i]:find('UU') then
        conflicted = conflicted + 1
      end
      if lines[i]:sub(1, 1):find('[MADRC]') then
        staged = staged + 1
      end
      if lines[i]:sub(2, 2):find('[^%s!]') then
        unstaged = unstaged + 1
      end
    end

    return string.format('  %s +%s ~%s !%s', branch, staged, unstaged, conflicted)
  end

  local prompt = nyagos.default_prompt

  nyagos.prompt = function(this)
    local stats = branch_info()
    local title = 'NYAGOS - ' .. nyagos.getwd()
    if stats then
      stats = string.format('$e[49;90m$e[100;93m%s $e[49;90m ', stats)
    else
      stats = '$e[49;49m'
    end

    if nyagos.elevated() then
      return prompt(
        string.format('$e[0m$e[49;36m%s%s$e[92m%s$_$s$e[49;39m', this, stats, os.date('%H:%M:%S')),
        title
      )
    else
      return prompt(
        string.format('$e[0m$e[49;36m%s%s$e[92m%s$_$s$e[49;39m', this, stats, os.date('%H:%M:%S')),
        title
      )
    end
  end
end

-- options
nyagos.histsize = 200

-- system env
nyagos.env.tar80 = 'C:\\bin\\repository\\tar80'
nyagos.envadd('PATH', '%scoop%\\apps\\git\\current\\usr\\bin')

nyagos.env.LESSCHARSET = 'utf-8'
nyagos.env.FZF_DEFAULT_COMMAND = 'fd -HL -c never --exclude ".git" .'
local fzf_opts = {
  '--exit-0',
  '--reverse',
  '--margin=0,1',
  '--height 80%',
  '--inline-info',
  '--bind ctrl-f:page-down,ctrl-b:page-up',
  '--bind pgdn:preview-page-down,pgup:preview-page-up',
  '--color=fg:-1,bg:-1,hl:#FFCC00',
  '--color=fg+:#4D84A8,bg+:-1,hl+:#00EAFF',
  '--color=info:#AA82FA,prompt:#2CDEDE,pointer:#6BFF26',
  '--color=marker:#C06EFF,spinner:#A357FF,header:#A7D1D1',
}
nyagos.env.FZF_DEFAULT_OPTS = table.concat(fzf_opts, ' ')
nyagos.env._ZO_FZF_OPTS = (function(opts)
  table.insert(opts, '--preview="bat --color=always --style=numbers --line-range=:50 "{2..}/readme.md""')
  return table.concat(opts, ' ')
end)(fzf_opts)

local fzf = {
  cmd = 'fzf.exe',
}
setmetatable(fzf, {
  __index = {
    gitlog = function(self)
      return self.cmd .. ' --preview="git show {1}"'
    end,
    gitdiff = function(self)
      return self.cmd .. ' --preview="echo {2} |xargs git diff --color"'
    end,
  },
})

-- alias
nyagos.alias.__dump_history = function()
  local uniq = {}
  for i = nyagos.gethistory() - 1, 1, -1 do
    local line = nyagos.gethistory(i)
    if line ~= '' and not uniq[line] then
      nyagos.write(line, '\n')
      uniq[line] = true
    end
  end
end
nyagos.alias.keyp = 'C:\\bin\\Keypirinha\\keypirinha.exe'
nyagos.alias.zi = function()
  local path = nyagos.eval('zoxide query -i')
  return nyagos.exec('cd ' .. path)
end
nyagos.alias.z = function(arg)
  local path = nyagos.eval('zoxide query ' .. arg[1])
  return nyagos.exec('cd ' .. path)
end
nyagos.alias.ll = 'lsd -l --group-dirs first --blocks permission --blocks size --blocks date --blocks name '
nyagos.alias.cc = function()
  local path = nyagos.eval('fd -Ht d -c never -E .git -E node_modules | fzf')
  return nyagos.exec('cd ' .. path)
end
nyagos.alias.re = function(this)
  local result = nyagos.eval('__dump_history | ' .. fzf.cmd)
  this:call('REPAINT_ON_NEWLINE')
  return result
end
nyagos.alias.gd = function()
  local cmd = 'git status -s -uall|%s' .. fzf:gitdiff()
  local stdout = nyagos.eval(cmd)
  if not (stdout == '' or stdout:find('^fatal:')) then
    return nyagos.exec('nvim ' .. stdout:sub(3))
  end
end

-- Completion. Highlighting input parts
-- nyagos.completion_hook = function(c)
--   local len = c.word:gsub('.+[/\\]', ''):len()
--   for index, item in ipairs(c.shownlist) do
--     local _item = string.format('\027[49;93m%s\027[49;39m%s', item:sub(1, len), item:sub(len + 1))
--     c.shownlist[index] = _item .. "test"
--   end
--   return c.shownlist
-- end

-- keys
nyagos.key['F1'] = function()
  nyagos.rawexec('c:\\bin\\cltc\\cltc.exe')
end

nyagos.key['F9'] = function()
  nyagos.exec('nvim %tar80%\\myrepo\\nyagos\\.nyagos')
end

nyagos.bindkey('C_R', function()
  local path = nyagos.eval('fd -Lt d -c never --full-path . %tar80% | fzf')
  if path ~= '' then
    nyagos.eval('zoxide add ' .. path)
    return nyagos.exec('cd ' .. path)
  end
end)

nyagos.bindkey('M_H', function(this)
  local cmd = string.format('%s|%s', 'cd --history', fzf.cmd)
  local cwd = string.format('cd "%s"', nyagos.eval(cmd))
  nyagos.exec(cwd)
  this:call('REPAINT_ON_NEWLINE')
end)

nyagos.bindkey('M_G', function()
  local result = nyagos.eval('git log --pretty="format:%h %s"|' .. fzf:gitlog())
  return string.match(result, '^%S+') or ''
end)

use('git')

-- vim:set ft=lua:
